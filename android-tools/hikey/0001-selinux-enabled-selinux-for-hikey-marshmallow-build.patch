From b3d49c71f378e30c11c47304f7e9f7f354ec1b20 Mon Sep 17 00:00:00 2001
From: Yongqin Liu <yongqin.liu@linaro.org>
Date: Fri, 20 Nov 2015 02:30:07 +0800
Subject: [PATCH] selinux: enabled selinux for hikey marshmallow build

Signed-off-by: Yongqin Liu <yongqin.liu@linaro.org>
---
 BoardConfig.mk     |  7 ++++++-
 grub.cfg           |  6 +++---
 init.hikey.rc      | 10 ----------
 sepolicy/kernel.te |  5 +++--
 ueventd.hikey.rc   |  3 +++
 5 files changed, 15 insertions(+), 16 deletions(-)

diff --git a/BoardConfig.mk b/BoardConfig.mk
index 21ed3b4..eb57952 100644
--- a/BoardConfig.mk
+++ b/BoardConfig.mk
@@ -77,13 +77,18 @@ BOARD_SEPOLICY_DIRS += device/linaro/build/sepolicy
 BOARD_SEPOLICY_UNION += \
         file_contexts \
         gatord.te  \
+        hci_attach.te \
+        healthd.te \
         init.te  \
         kernel.te  \
+        linaro.te \
         logd.te  \
         mediaserver.te  \
         netd.te  \
         shell.te  \
-        surfaceflinger.te
+        surfaceflinger.te \
+        toolbox.te \
+        zygote.te
 
 BOARD_SEPOLICY_DIRS += device/linaro/hikey/sepolicy
 BOARD_SEPOLICY_UNION += \
diff --git a/grub.cfg b/grub.cfg
index 71cacf9..3917edd 100644
--- a/grub.cfg
+++ b/grub.cfg
@@ -4,7 +4,7 @@ set timeout=1
 menuentry 'AOSP@720P' {
     search.fs_label boot root
     set root=($root)
-    linux /Image console=ttyAMA3,115200 androidboot.console=ttyAMA3 androidboot.hardware=hikey firmware_class.path=/system/etc/firmware efi=noruntime video=HDMI-A-1:1280x720@60 androidboot.selinux=permissive
+    linux /Image console=ttyAMA3,115200 androidboot.console=ttyAMA3 androidboot.hardware=hikey firmware_class.path=/system/etc/firmware efi=noruntime video=HDMI-A-1:1280x720@60
     initrd /ramdisk.img
     devicetree /hi6220-hikey.dtb
 }
@@ -12,7 +12,7 @@ menuentry 'AOSP@720P' {
 menuentry 'AOSP@SVGA' {
     search.fs_label boot root
     set root=($root)
-    linux /Image console=ttyAMA3,115200 androidboot.console=ttyAMA3 androidboot.hardware=hikey firmware_class.path=/system/etc/firmware efi=noruntime video=HDMI-A-1:800x600@60 androidboot.selinux=permissive
+    linux /Image console=ttyAMA3,115200 androidboot.console=ttyAMA3 androidboot.hardware=hikey firmware_class.path=/system/etc/firmware efi=noruntime video=HDMI-A-1:800x600@60
     initrd /ramdisk.img
     devicetree /hi6220-hikey.dtb
 }
@@ -20,7 +20,7 @@ menuentry 'AOSP@SVGA' {
 menuentry 'AOSP' {
     search.fs_label boot root
     set root=($root)
-    linux /Image console=ttyAMA3,115200 androidboot.console=ttyAMA3 androidboot.hardware=hikey firmware_class.path=/system/etc/firmware efi=noruntime androidboot.selinux=permissive
+    linux /Image console=ttyAMA3,115200 androidboot.console=ttyAMA3 androidboot.hardware=hikey firmware_class.path=/system/etc/firmware efi=noruntime
     initrd /ramdisk.img
     devicetree /hi6220-hikey.dtb
 }
diff --git a/init.hikey.rc b/init.hikey.rc
index dd523aa..02ee7cf 100644
--- a/init.hikey.rc
+++ b/init.hikey.rc
@@ -17,11 +17,6 @@ on init
     # (if randomization is enabled the AEM-JIT will have a lower cache hit rate)
     write /proc/sys/kernel/randomize_va_space 0
 
-#bluetooth
-   #UART device
-   chmod 0660 /dev/ttyAMA1
-   chown bluetooth net_bt_stack /dev/ttyAMA1
-
 on fs
     mount_all /fstab.hikey
     setprop ro.crypto.fuse_sdcard false
@@ -83,16 +78,11 @@ on post-fs
     # insert gator kernel module for DS-5/Streamline
     insmod /system/modules/gator.ko
 
-    # insert mali gpu module
-    insmod /system/modules/mali.ko mali_debug_level=2
-
     # BT LED sysfs entry
     write /sys/devices/leds/leds/bt_active/trigger "hci1rx"
 
     chmod 0666 /dev/ump
     chmod 0666 /dev/ion
-    chmod 0666 /dev/mali
-    chown system.graphics /dev/mali
     chmod 0666 /dev/graphics/fb0
 
 on boot
diff --git a/sepolicy/kernel.te b/sepolicy/kernel.te
index bbcc4b2..a22c319 100644
--- a/sepolicy/kernel.te
+++ b/sepolicy/kernel.te
@@ -3,5 +3,6 @@ allow kernel self:capability net_bind_service;
 
 # for kdevtmpfs command
 allow kernel self:capability mknod;
-allow kernel device:dir { write add_name };
-allow kernel device:chr_file { create setattr getattr};
+allow kernel device:dir { write add_name rmdir remove_name rmdir remove_name};
+allow kernel device:chr_file { create setattr getattr unlink };
+allow kernel self:system module_request;
diff --git a/ueventd.hikey.rc b/ueventd.hikey.rc
index 9f1b2ef..f0cb78d 100644
--- a/ueventd.hikey.rc
+++ b/ueventd.hikey.rc
@@ -1 +1,4 @@
 /dev/hci_tty     0666 root root
+/dev/mali        0666 system graphics
+#bluetooth
+/dev/ttyAMA1     0660 bluetooth net_bt_stack
-- 
1.9.1

